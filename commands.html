<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script>
        Office.onReady(() => {
            console.log("Add-in initialized");
        });

        // This handles the Ribbon Button click
        function action(event) {
            console.log("Manual check triggered");
            // You can put manual check logic here
            event.completed(); 
        }

        // This handles the actual Send event
        async function checkRecipientsBeforeSend(event) {
            try {
                const item = Office.context.mailbox.item;
                const internalDomain = "clearviewhort.com";
                const externalDomains = new Set();

                // Get Recipients
                const toRecipients = await getRecipientsAsync(item.to);
                const ccRecipients = await getRecipientsAsync(item.cc);
                const bccRecipients = await getRecipientsAsync(item.bcc);
                const allRecipients = [...toRecipients, ...ccRecipients, ...bccRecipients];

                for (const recipient of allRecipients) {
                    const email = (recipient.emailAddress || "").toLowerCase().trim();
                    if (email.includes("@")) {
                        const domain = email.split("@")[1];
                        if (domain !== internalDomain) {
                            externalDomains.add(domain);
                        }
                    }
                }

                if (externalDomains.size >= 2) {
                    const domainList = Array.from(externalDomains).join(", ");
                    const userConfirmed = await showConfirmDialog(domainList);
                    
                    if (!userConfirmed) {
                        event.completed({ allowEvent: false });
                        return;
                    }
                }

                // SUCCESS: Tell Outlook it is okay to send
                event.completed({ allowEvent: true });

            } catch (error) {
                console.error("Error:", error);
                // Safety: Allow send if the code crashes
                event.completed({ allowEvent: true });
            }
        }

        function getRecipientsAsync(recipientField) {
            return new Promise((resolve) => {
                recipientField.getAsync((result) => {
                    resolve(result.status === Office.AsyncResultStatus.Succeeded ? result.value : []);
                });
            });
        }

        function showConfirmDialog(domainList) {
            return new Promise((resolve) => {
                const message = `Multiple external domains detected: ${domainList}. Send anyway?`;
                const url = `https://byclevw.github.io/outlookaddin/dialog.html?message=${encodeURIComponent(message)}`;
                
                Office.context.ui.displayDialogAsync(url, { height: 30, width: 40 }, (result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        const dialog = result.value;
                        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
                            dialog.close();
                            resolve(arg.message === "yes");
                        });
                        dialog.addEventHandler(Office.EventType.DialogEventReceived, () => {
                            resolve(true); // User closed X, allow send by default
                        });
                    } else {
                        resolve(true); // Dialog failed to open, don't block user
                    }
                });
            });
        }

        // Mapping function names in manifest to JS functions
        Office.actions.associate("checkRecipientsBeforeSend", checkRecipientsBeforeSend);
        Office.actions.associate("action", action);
    </script>
</head>
<body>
    <p>External Domain Warning Working...</p>
</body>
</html>